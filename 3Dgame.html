<!DOCTYPE html>
<html>
<head>

<title>3DOX</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>

<script>
function dist3(l){return (l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);}//for comparisons, does not sqrt
function dist2(x,y){return Math.sqrt(x*x+y*y);}
function mid3(a,b){return [(a[0]+b[0])/2,(a[1]+b[1])/2,(a[2]+b[2])/2];}
function theta(x,y){
  if(y==0){return Math.PI/4*x/Math.abs(x);}
  return Math.atan(x/y)+(y<0?Math.PI/4:0)*x/Math.abs(x);
  }

function rotate(x,y,a){return [x*Math.cos(a)-y*Math.sin(a),y*Math.cos(a)+x*Math.sin(a)];}

String.prototype.lpad = function(padString, length) {
	var str = this;
	while (str.length < length)
		str = padString + str;
	return str;
};

Array.prototype.insert=function (index, arrayToInsert) {
        Array.prototype.splice.apply(this, [index, 0].concat(arrayToInsert));
        return this;
    }

function col(r,g,b){
  return "#"+(b+g*256+r*256*256).toString(16).lpad("0",6)}

function drawline(a,b){//draws a line from a to b
  ctx.beginPath();
  ctx.moveTo(a[0],a[1]);
  ctx.lineTo(b[0],b[1]);
  ctx.stroke();
  }
  
function drawcirc(x,y,r){//draws a line from a to b
  ctx.beginPath();
  ctx.arc(x,y,r,0,Math.PI*2);
  ctx.stroke();
  }


/* //give the game an id
var gameID={{gameID}}
var timer

function postMsg(data){$("#error").val(data.error);}


function Show(data){
  var c=document.getElementById("myCanvas");
  var ctx=c.getContext("2d");
  ctx.lineWidth=3
  for(z=0;z<4;z++){
    for(y=0;y<4;y++){
      for(x=0;x<4;x++){
			  ctx.fillStyle=col(255-32*x,255-32*y,255-40*z);
			  ctx.fillRect(32*x,128*z+32*y,32,32);
        if (data.board[z*16+y*4+x]=="X"){drawX(ctx,x,y,z);}
        else if (data.board[16*z+y*4+x]=="O"){drawO(ctx,x,y,z);}
        }
      }
    }
  for (i in data.wonlines){
    line=data.wonlines[i]
    for(j=0;j<4;j++){
      ctx.beginPath();
      ctx.arc((line[j][0]+0.5)*sz,(line[j][1]+0.5+4*line[j][2])*sz,sz/4,0 , 2 * Math.PI, false);
      ctx.fillStyle="yellow"
      ctx.fill();
      }
    }
  }

function drawX(ctx,x,y,z){
  ctx.beginPath();
  ctx.strokeStyle="blue"
  ctx.moveTo(x*sz+2,y*sz+z*sz*4+2);
  ctx.lineTo(x*sz+sz-2,y*sz+z*sz*4+sz-2);
  ctx.moveTo(x*sz+2,y*sz+z*sz*4+sz-2);
  ctx.lineTo(x*sz+sz-2,y*sz+z*sz*4+2);
  ctx.stroke();
  }

function drawO(ctx,x,y,z){
  ctx.beginPath();
  ctx.strokeStyle="red"
  ctx.arc((x+0.5)*sz,(y+0.5+4*z)*sz,sz/2-2,0 , 2 * Math.PI, false);
  ctx.stroke();
}
//functions independent of IO
function click(pos,player){
  $.post('post?pos='+pos+'&gameID='+gameID+'&player='+player,
  postMsg,'json')
  }
  
function poll(player){
  $.getJSON('get',{'gameID':gameID,'player':player}, Show);
  }

//end of IO independent functions
$.ajaxSetup({cache:false});

*/

function st(){clearInterval(timer);}
</script>
</head>
<body>


<div id="top" style="background-color:lightblue;font-size:20pt">
  Welcome to my webpage where you can play 3D noughts and crosses
</div>
<div id="main" style="background-color:#FFFFFF;float:left;">
  <div id="controls">
    <input type="text" id="player" value="X"></input>
    <input type="button" onclick="$.post('clr',{'gameID':gameID});"></input>
    <input type="text" id="error" value="" disabled="disabled"></input>
  </div>
  
  <div id="game">
    <canvas id="Canvas" width=500 height=500>
      your browser does not support this feature
    </canvas>
    <form name="options">
      Slipperiness:<input name="slipperiness" type="range" value=75 onchange="SLIPPERINESS=Math.sqrt(1-(opts.slipperiness.value-100)*(opts.slipperiness.value-100)/10000);"><br />
      Sensitivity:<input name="sensitivity" type="range" value=7 onchange="SENSITIVITY=Math.exp(opts.sensitivity.value/25.0-6.5);"><br />
      Distance:<input name="distance" type="range" value=0 onchange="VIEWDIST=200/(opts.distance.value*1.0+150);"><br />
    </form>
    <script>

var Canvas=document.getElementById("Canvas");
var ctx=Canvas.getContext("2d");

var CUBECENTER=[0.0,0.0,7.0];
var VIEWDIST=4.0/3;
var VIEWSIZE=0.7;
var CANVASSIZE=500;
var SENSITIVITY=0.002;
var SLIPPERINESS=Math.sqrt(1-0.25*0.25);

var gap=0.3;
var edges=[]//pairs of numbers representing the pairs of verticies in a cube between which there are edges
for (var i=0;i<7;i++){
  if (!(1&i)){edges.push([i,i+1]);}
  if (!(2&i)){edges.push([i,i+2]);}
  if (!(4&i)){edges.push([i,i+4]);}
  }


var opts=document.options;



//initalize the cells and verticies
/*the cells are stored as an object with 0,0,0 , 0,0,1 ... 3,3,3 as keys.
The data stored about each cell is a list, containing the closest integer coordinate to the cell at the bottom left front, followed by the coordinates of each corner, then the contents of the cell*/
var cells={};


for(z=0;z<4;z++){
  for(y=0;y<4;y++){
    for(x=0;x<4;x++){
      cells[[x,y,z]]=[[CUBECENTER[0]-1.5+x,CUBECENTER[1]-1.5+y,CUBECENTER[2]-1.5+z]];
      }
    }
  }

for(index in cells){
  cell=cells[index];
  var c=cell[0];
  var x=c[0];
  var y=c[1];
  var z=c[2];
  for(var k=0;k<8;k++){
    cell.push([x+(k&1?0.5-gap:gap-0.5),y+(k&2?0.5-gap:gap-0.5),z+(k&4?0.5-gap:gap-0.5)]);
    }
  cell.push("O");
  }

var scells=[];//sorted in order of distance from the viewer, furthest first
var coords={};//canvas coordinates of each corner



function sortcells(){
  scells=[];
  for(i in cells){scells.push([i,dist3(cells[i][0])]);}
  scells.sort(function(a,b){return b[1]-a[1]});
  }

function mappoint(pos){//maps a point in 3d space to a point on the canvas
  var x=Math.round((pos[0]/(pos[2]/VIEWDIST)/VIEWSIZE+1)*CANVASSIZE/2);
  var y=Math.round((pos[1]/(pos[2]/VIEWDIST)/VIEWSIZE+1)*CANVASSIZE/2);
  return [x,y];}




  
function drawcell(n,cellpos){//draws a cell and any token inside it
  var co=coords[cellpos[0]];//the canvas coordinates of each corner of the cell 
  var cell=cells[cellpos[0]];
  var x=cellpos[0][0];
  var y=cellpos[0][2];
  var z=cellpos[0][4];
  
  var lineWidth=5.0/Math.sqrt(cellpos[1]);
  ctx.lineWidth=((-x-y-z*1.5)*(-x-y-z*1.5)/80+1)*lineWidth;
  ctx.strokeStyle=col(60*x,60*y,60*z);
  
  var e=[]
  for (var i=0;i<edges.length;i++){
    var pair=edges[i];
    e.push([co[pair[0]],co[pair[1]],dist3(mid3(cell[pair[0]+1],cell[pair[1]+1]))]);
    }//list all edges in this cube
    
  for (var i=0;i<e.length;i++){
    if (e[i][2]>cellpos[1]){drawline(e[i][0],e[i][1]);}
    }
    
  ctx.lineWidth=lineWidth*2;
  if (cell[9]=="X"){
    ctx.strokeStyle="#0000ff";
    for (var i=0;i<4;i++){
      drawline(co[i],co[(~i)&7]);//draw a line to the opposite corner
      }
    }
  if (cell[9]=="O"){
    ctx.strokeStyle="#ff0000";
    drawcirc(co[8][0],co[8][1],lineWidth*15);
    }
    
  ctx.strokeStyle=col(60*x,60*y,60*z);
  ctx.lineWidth=((-x-y-z*1.5)*(-x-y-z*1.5)/80+1)*lineWidth;
  for (var i=0;i<e.length;i++){
    if (e[i][2]<=cellpos[1]){drawline(e[i][0],e[i][1]);}
    }
  }


function draw(){//draws the grid of cells onto the canvas
  sortcells()
  
  for(var index in cells){
    coords[index]=[];
    var cs=cells[index].slice(1,9);
    for (var n=0;n<cs.length;n++){coords[index].push(mappoint(cs[n]));}
    coords[index].push(mappoint(cells[index][0]));
    }
  ctx.beginPath();
  ctx.rect(0,0,CANVASSIZE,CANVASSIZE);
  ctx.fillStyle = 'white';
  ctx.fill();
  $.each(scells,drawcell);
  }
draw()


function pitch(a){
  var index,i,yz,xyz;
  for(index in cells){
      var cell=cells[index];
      var s=cell.slice(0,9);
      for(i in s){
          xyz=s[i];
          yz=rotate(xyz[1]-CUBECENTER[1],xyz[2]-CUBECENTER[2],a);
          xyz[1]=yz[0]+CUBECENTER[1];
          xyz[2]=yz[1]+CUBECENTER[2];
          }
      }
  }


function yaw(a){
  var index,i,xz,xyz;
  for(index in cells){
      cell=cells[index];
      s=cell.slice(0,9);
      for(i in s){
          xyz=s[i];
          xz=rotate(xyz[0]-CUBECENTER[0],xyz[2]-CUBECENTER[2],a);
          xyz[0]=xz[0]+CUBECENTER[0];
          xyz[2]=xz[1]+CUBECENTER[2];
          }
      }
  }



var avp=0.000;
var avy=0.00;
$(document).ready(function(){
  timer=setInterval(function(){
    pitch(avp);
    yaw(avy);
    draw();
    avp*=SLIPPERINESS;
    avy*=SLIPPERINESS;
    
    }, 10);
  });

var rmb=false


Canvas.onmousedown=function(e){if(e.button==2){rmb=true}};
Canvas.onmouseup=function(e){
  if(e.button==2){rmb=false}};
Canvas.onmousemove=function(e){if(rmb){
    avp=(e.MovementY||e.webkitMovementY||e.mozMovementY||0)*SENSITIVITY;
    avy=(e.MovementX||e.webkitMovementX||e.mozMovementX||0)*SENSITIVITY;
    draw();vv=e;}
  };
Canvas.oncontextmenu=function(e){return false;};

 
    </script>
  </div>

  <div id="links">
    <a href="?gameID={{gameID}}&pageType=table">basic version (for older browsers)</a><br />
    <a href="?gameID={{gameID}}&pageType=canvas">canvas</a>
  </div>
</div>

<div id="rules" style="background-color:green;color:orange;width:400px;float:right;">
  This layout does not currently show moves or let you make them.<br>
  If you right-click and drag, the cube spins<br>
  Works in chrome and firefox, if you arn't using chrome, parameters should be between 0 and 100
</div>

</body>
</html>