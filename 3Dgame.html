<!DOCTYPE html>
<html>
<head>

<title>3DOX</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>

<script>
function dist3(l){return Math.sqrt(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);}
function dist2(x,y){return Math.sqrt(x*x+y*y);}
function theta(x,y){
  if(y==0){return Math.PI/4*x/Math.abs(x);}
  return Math.atan(x/y)+(y<0?Math.PI/4:0)*x/Math.abs(x);
  }

function rotate(x,y,a){return [x*Math.cos(a)-y*Math.sin(a),y*Math.cos(a)+x*Math.sin(a)];}

String.prototype.lpad = function(padString, length) {
	var str = this;
	while (str.length < length)
		str = padString + str;
	return str;
};

Array.prototype.insert=function (index, arrayToInsert) {
        Array.prototype.splice.apply(this, [index, 0].concat(arrayToInsert));
        return this;
    }

function col(r,g,b){
  return "#"+(b+g*256+r*256*256).toString(16).lpad("0",6)}


/* //give the game an id
var gameID={{gameID}}
var timer

function postMsg(data){$("#error").val(data.error);}


function Show(data){
  var c=document.getElementById("myCanvas");
  var ctx=c.getContext("2d");
  ctx.lineWidth=3
  for(z=0;z<4;z++){
    for(y=0;y<4;y++){
      for(x=0;x<4;x++){
			  ctx.fillStyle=col(255-32*x,255-32*y,255-40*z);
			  ctx.fillRect(32*x,128*z+32*y,32,32);
        if (data.board[z*16+y*4+x]=="X"){drawX(ctx,x,y,z);}
        else if (data.board[16*z+y*4+x]=="O"){drawO(ctx,x,y,z);}
        }
      }
    }
  for (i in data.wonlines){
    line=data.wonlines[i]
    for(j=0;j<4;j++){
      ctx.beginPath();
      ctx.arc((line[j][0]+0.5)*sz,(line[j][1]+0.5+4*line[j][2])*sz,sz/4,0 , 2 * Math.PI, false);
      ctx.fillStyle="yellow"
      ctx.fill();
      }
    }
  }

function drawX(ctx,x,y,z){
  ctx.beginPath();
  ctx.strokeStyle="blue"
  ctx.moveTo(x*sz+2,y*sz+z*sz*4+2);
  ctx.lineTo(x*sz+sz-2,y*sz+z*sz*4+sz-2);
  ctx.moveTo(x*sz+2,y*sz+z*sz*4+sz-2);
  ctx.lineTo(x*sz+sz-2,y*sz+z*sz*4+2);
  ctx.stroke();
  }

function drawO(ctx,x,y,z){
  ctx.beginPath();
  ctx.strokeStyle="red"
  ctx.arc((x+0.5)*sz,(y+0.5+4*z)*sz,sz/2-2,0 , 2 * Math.PI, false);
  ctx.stroke();
}
//functions independent of IO
function click(pos,player){
  $.post('post?pos='+pos+'&gameID='+gameID+'&player='+player,
  postMsg,'json')
  }
  
function poll(player){
  $.getJSON('get',{'gameID':gameID,'player':player}, Show);
  }

//end of IO independent functions
$.ajaxSetup({cache:false});

*/

function st(){clearInterval(timer);}
</script>
</head>
<body>


<div id="top" style="background-color:lightblue;font-size:20pt">
  Welcome to my webpage where you can play 3D noughts and crosses
</div>
<div id="main" style="background-color:#FFFFFF;float:left;">
  <div id="controls">
    <input type="text" id="player" value="X"></input>
    <input type="button" onclick="$.post('clr',{'gameID':gameID});"></input>
    <input type="text" id="error" value="" disabled="disabled"></input>
  </div>
  
  <div id="game">
    <canvas id="myCanvas" width=500 height=500>
      your browser does not support this feature
    </canvas>
    <script>

var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");

var VIEWDIST=1.0;
var VIEWSIZE=1.0;
var CANVASSIZE=500;
var CUBECENTER=[0.0,0.0,5.0];


var gap=0.3;

//initalize the cells and verticies
/*the cells are stored as an object with 0,0,0 , 0,0,1 ... 3,3,3 as keys.
The data stored about each cell is a list, containing the closest integer coordinate to the cell at the bottom left front, followed by the coordinates of each corner, then the contents of the cell*/
var cells={};
for(z=0;z<4;z++){
  for(y=0;y<4;y++){
    for(x=0;x<4;x++){
      cells[[x,y,z]]=[[CUBECENTER[0]-2+x,CUBECENTER[1]-2+y,CUBECENTER[2]-2+z]];
      }
    }
  }

$.each(cells,function (index,cell){
  c=cell[0];
  x=c[0];
  y=c[1];
  z=c[2];
  for(k=0;k<8;k++){
    cell.push([x+(k&1?1-gap:gap),y+(k&2?1-gap:gap),z+(k&4?1-gap:gap)]);
    }
  cell.push(" ");
  })

var scells=[];//sorted in order of distance from the viewer, furthest first
var coords={};//canvas coordinates of each corner



function sortcells(){
  scells=[];
  $.each(cells,function(i,cell){scells.push([i,dist3(cell[0])]);});
  scells.sort(function(a,b){return b[1]-a[1]});
  }

function mappoint(pos){//maps a point in 3d space to a point on the canvas
  var x=Math.round((pos[0]/(pos[2]/VIEWDIST)/VIEWSIZE+1)*CANVASSIZE/2);
  var y=Math.round((pos[1]/(pos[2]/VIEWDIST)/VIEWSIZE+1)*CANVASSIZE/2);
  return [x,y];}




function drawline(a,b,col){
  ctx.beginPath();
  ctx.moveTo(a[0],a[1]);
  ctx.lineTo(b[0],b[1]);
  ctx.strokeStyle=col;
  ctx.stroke();
  }
  
function drawcell(n,cell){
  co=coords[cell[0]];
  x=cell[0][0];
  y=cell[0][2];
  z=cell[0][4];
  ctx.lineWidth=5.0/cell[1]
  $.each(co,function(i,e){
      if (!(1&i)){drawline(e,co[i+1],col(60*x,60*y,40*z));}
      if (!(2&i)){drawline(e,co[i+2],col(60*x,60*y,40*z));}
      if (!(4&i)){drawline(e,co[i+4],col(60*x,60*y,40*z));}
      });
  }

function draw(){
  sortcells()
  
  $.each(cells,function(index,cell){
    coords[index]=[]
    $.each(cell.slice(1,9),function(n,vertex){coords[index].push(mappoint(vertex))});
    });
  ctx.beginPath();
  ctx.rect(0,0,CANVASSIZE,CANVASSIZE);
  ctx.fillStyle = 'white';
  ctx.fill();
  $.each(scells,drawcell);
  }
draw()



function yaw(a){
  $.each(cells,function(index,cell){
      $.each(cell.slice(0,9),function(i,xyz){
          xz=rotate(xyz[0]-CUBECENTER[0],xyz[2]-CUBECENTER[2],a);
          xyz[0]=xz[0]+CUBECENTER[0];
          xyz[2]=xz[1]+CUBECENTER[2];
          });
      });
  draw();
  }

function pitch(a){
  $.each(cells,function(index,cell){
      $.each(cell.slice(0,9),function(i,xyz){
          xz=rotate(xyz[2]-CUBECENTER[2],xyz[1]-CUBECENTER[1],a);
          xyz[1]=xz[1]+CUBECENTER[1];
          xyz[2]=xz[0]+CUBECENTER[2];
          });
      });
  draw();
  }
  
pitch(Math.PI/4);
yaw(Math.PI/4);
var avp=0.005
var avy=0.01

$(document).ready(function(){
  timer=setInterval(function(){
    pitch(avp);
    yaw(avy);
    
    }, 1);
  });


/*$("#myCanvas").mousedown(function(e){
  click(getCell(e.offsetX,e.offsetY).join(""),$("#player").val())});*/
  
    </script>
  </div>

  <div id="links">
    <a href="?gameID={{gameID}}&pageType=table">basic version (for older browsers)</a><br />
    <a href="?gameID={{gameID}}&pageType=canvas">canvas</a>
  </div>
</div>

<div id="rules" style="background-color:green;color:orange;width:400px;float:right;">
  The cells represent 4 layers in a 4*4*4 cube. To win get four cells that form a line in the cube.<br>
  Click on a cell to make your move there.<br>
  <br>
  At the moment this is a very early version so you can change your counter by replacing the "X" in the text box with an "O", and reset the board by pressing the button next to it.
</div>

</body>
</html>